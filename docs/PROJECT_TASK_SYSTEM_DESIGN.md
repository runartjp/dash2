# プロジェクト・タスク管理システム 設計書

## 1. 概要

Directusバックエンドを使用したプロジェクト・タスク管理システムの全体設計。

## 2. データモデル

### 2.1 Projects（プロジェクト）

| フィールド名 | 型 | 必須 | 説明 | 実装状況 |
|------------|-----|------|------|---------|
| id | integer | ✓ | 自動採番ID | ✅ 実装済み |
| name | string | ✓ | プロジェクト名 | ✅ 実装済み |
| key | string | ✓ | プロジェクトキー (PROJ-001) | ✅ 実装済み |
| description | text | - | 説明 | ✅ 実装済み |
| status | string | ✓ | ステータス | ✅ 実装済み |
| priority | string | ✓ | 優先度 | ✅ 実装済み |
| start_date | date | - | 開始日 | ✅ 実装済み |
| end_date | date | - | 終了日 | ✅ 実装済み |
| progress | integer | ✓ | 進捗率 (0-100) | ✅ 実装済み |
| owner | uuid | - | オーナー (directus_users) | ✅ 実装済み |
| **auto_progress** | boolean | - | **自動進捗計算** | ⏳ 未実装 |
| **budget** | decimal | - | **予算** | ⏳ 未実装 |
| **actual_cost** | decimal | - | **実際のコスト** | ⏳ 未実装 |

**ステータス値:**
- `planning` - 計画中
- `active` - 進行中
- `on_hold` - 保留
- `completed` - 完了
- `cancelled` - キャンセル

**優先度値:**
- `low` - 低
- `medium` - 中
- `high` - 高
- `urgent` - 緊急

### 2.2 Tasks（タスク）

| フィールド名 | 型 | 必須 | 説明 | 実装状況 |
|------------|-----|------|------|---------|
| id | integer | ✓ | 自動採番ID | ✅ 実装済み |
| title | string | ✓ | タスク名 | ✅ 実装済み |
| description | text | - | 説明 | ✅ 実装済み |
| status | string | ✓ | ステータス | ✅ 実装済み |
| priority | string | ✓ | 優先度 | ✅ 実装済み |
| due_date | date | - | 期限 | ✅ 実装済み |
| project | integer | - | プロジェクトID | ✅ 実装済み |
| assignee | uuid | - | 担当者 (directus_users) | ✅ 実装済み |
| **progress** | integer | - | **タスク進捗率 (0-100)** | ⏳ 未実装 |
| **estimated_hours** | decimal | - | **見積時間** | ⏳ 未実装 |
| **actual_hours** | decimal | - | **実績時間** | ⏳ 未実装 |
| **parent_task** | integer | - | **親タスク（サブタスク機能）** | ⏳ 未実装 |
| **sort_order** | integer | - | **並び順** | ⏳ 未実装 |

**ステータス値:**
- `todo` - 未着手
- `in_progress` - 進行中
- `review` - レビュー中
- `done` - 完了

**優先度値:**
- `low` - 低
- `medium` - 中
- `high` - 高
- `urgent` - 緊急

### 2.3 新規コレクション（追加検討）

#### 2.3.1 Task Comments（タスクコメント）

| フィールド名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| id | integer | ✓ | 自動採番ID |
| task | integer | ✓ | タスクID |
| user | uuid | ✓ | コメント投稿者 |
| comment | text | ✓ | コメント内容 |
| date_created | timestamp | ✓ | 作成日時 |

#### 2.3.2 Task Attachments（タスク添付ファイル）

| フィールド名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| id | integer | ✓ | 自動採番ID |
| task | integer | ✓ | タスクID |
| file | uuid | ✓ | ファイル (directus_files) |
| uploaded_by | uuid | ✓ | アップロード者 |

#### 2.3.3 Project Members（プロジェクトメンバー）

| フィールド名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| id | integer | ✓ | 自動採番ID |
| project | integer | ✓ | プロジェクトID |
| user | uuid | ✓ | ユーザーID |
| role | string | ✓ | 役割 (owner/member/viewer) |

#### 2.3.4 Time Logs（作業時間記録）

| フィールド名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| id | integer | ✓ | 自動採番ID |
| task | integer | ✓ | タスクID |
| user | uuid | ✓ | 作業者 |
| hours | decimal | ✓ | 作業時間 |
| work_date | date | ✓ | 作業日 |
| description | text | - | 作業内容 |

## 3. 機能要件

### 3.1 プロジェクト進捗の自動計算 ⭐ 優先度：高

**要件:**
- プロジェクト内のタスクの進捗率から自動的にプロジェクト進捗を計算
- タスク完了数ベースまたは進捗率加重平均の選択可能

**計算方式:**

**方式A: タスク完了数ベース（シンプル）**
```
プロジェクト進捗 = (完了タスク数 / 全タスク数) × 100
```

**方式B: 進捗率加重平均（詳細）**
```
プロジェクト進捗 = Σ(各タスクの進捗率) / タスク数
```

**実装場所:**
- `POST /api/tasks` - タスク作成時
- `PATCH /api/tasks/[id]` - タスク更新時
- `DELETE /api/tasks/[id]` - タスク削除時

**APIフロー:**
1. タスクのステータス・進捗率を更新
2. 関連プロジェクトの全タスクを取得
3. 進捗率を計算
4. プロジェクトの`progress`フィールドを更新

### 3.2 編集・削除機能 ⭐ 優先度：高

#### 3.2.1 プロジェクト編集

**画面:** `/projects/[id]/edit`

**機能:**
- 全フィールドの編集
- バリデーション
- 保存時の確認ダイアログ

#### 3.2.2 プロジェクト削除

**機能:**
- 削除前の確認ダイアログ
- 関連タスクの処理選択:
  - オプション1: タスクも全て削除
  - オプション2: タスクを別プロジェクトに移動
  - オプション3: タスクのプロジェクト紐付けを解除

#### 3.2.3 タスク編集

**画面:** `/tasks/[id]/edit`

**機能:**
- 全フィールドの編集
- プロジェクト変更時の自動進捗再計算
- 担当者変更時の通知（将来実装）

#### 3.2.4 タスク削除

**機能:**
- 削除前の確認ダイアログ
- 削除後のプロジェクト進捗再計算

### 3.3 スケジュール連携 ⭐ 優先度：中

#### 3.3.1 カレンダービュー

**画面:** `/schedule` または `/calendar`

**表示内容:**
- プロジェクトの開始日・終了日
- タスクの期限
- ガントチャート風の表示（オプション）

**ライブラリ候補:**
- `react-big-calendar`
- `@fullcalendar/react`
- カスタム実装

#### 3.3.2 タイムライン表示

**画面:** `/projects/[id]/timeline`

**表示内容:**
- プロジェクト期間
- タスクの期間（開始日・終了日を追加）
- マイルストーン（将来実装）

### 3.4 ダッシュボード ⭐ 優先度：中

**画面:** `/dashboard` または `/`

**表示内容:**
1. **統計サマリー**
   - 進行中のプロジェクト数
   - 今週の期限タスク数
   - 期限切れタスク数
   - 完了率

2. **最近の活動**
   - 最近更新されたプロジェクト
   - 新規作成タスク
   - 完了したタスク

3. **担当タスク一覧**
   - ログインユーザーに割り当てられたタスク
   - 優先度順ソート

4. **進捗グラフ**
   - プロジェクト別進捗
   - 週次・月次タスク完了数

### 3.5 フィルタリング・検索 ⭐ 優先度：中

#### 3.5.1 プロジェクト一覧

**フィルター:**
- ステータス
- 優先度
- オーナー
- 進捗範囲 (0-25%, 26-50%, 51-75%, 76-100%)

**検索:**
- プロジェクト名
- キー
- 説明

#### 3.5.2 タスク一覧

**フィルター:** ✅ 一部実装済み
- ステータス ✅
- 優先度 ✅
- プロジェクト
- 担当者
- 期限範囲

**検索:**
- タスク名
- 説明

### 3.6 通知機能 ⭐ 優先度：低

**通知トリガー:**
- タスク割り当て時
- 期限1日前
- プロジェクト完了時
- コメント投稿時

**通知方法:**
- アプリ内通知
- メール通知（オプション）

### 3.7 レポート機能 ⭐ 優先度：低

**レポート種類:**
1. プロジェクト進捗レポート
2. タスク完了レポート
3. 工数集計レポート（Time Logs実装後）
4. メンバー別作業量レポート

## 4. UI/UX設計

### 4.1 画面一覧

| 画面パス | 画面名 | 実装状況 |
|---------|--------|---------|
| `/dashboard` | ダッシュボード | ⏳ 未実装 |
| `/projects` | プロジェクト一覧 | ✅ 実装済み |
| `/projects/new` | プロジェクト新規作成 | ⏳ 未実装 |
| `/projects/[id]` | プロジェクト詳細 | ✅ 実装済み |
| `/projects/[id]/edit` | プロジェクト編集 | ⏳ 未実装 |
| `/projects/[id]/timeline` | プロジェクトタイムライン | ⏳ 未実装 |
| `/tasks` | タスク一覧 | ✅ 実装済み |
| `/tasks/new` | タスク新規作成 | ⏳ 未実装 |
| `/tasks/[id]` | タスク詳細 | ✅ 実装済み |
| `/tasks/[id]/edit` | タスク編集 | ⏳ 未実装 |
| `/schedule` | スケジュール/カレンダー | ⏳ 未実装 |

### 4.2 共通コンポーネント

#### 4.2.1 必要なコンポーネント

1. **ProgressBar** - 進捗バー ✅ 実装済み（プロジェクト詳細で使用）
2. **StatusBadge** - ステータスバッジ ✅ 実装済み
3. **PriorityBadge** - 優先度バッジ ✅ 実装済み
4. **DatePicker** - 日付選択 ⏳ 未実装
5. **ConfirmDialog** - 確認ダイアログ ⏳ 未実装
6. **FormInput** - フォーム入力 ⏳ 未実装
7. **UserSelect** - ユーザー選択ドロップダウン ⏳ 未実装
8. **ProjectSelect** - プロジェクト選択ドロップダウン ⏳ 未実装
9. **LoadingSpinner** - ローディング表示 ⏳ 未実装

## 5. API設計

### 5.1 既存API（実装済み）

| メソッド | エンドポイント | 説明 | 実装状況 |
|---------|--------------|------|---------|
| GET | `/api/projects` | プロジェクト一覧取得 | ✅ |
| POST | `/api/projects` | プロジェクト作成 | ✅ |
| GET | `/api/projects/[id]` | プロジェクト詳細取得 | ✅ |
| PATCH | `/api/projects/[id]` | プロジェクト更新 | ✅ |
| DELETE | `/api/projects/[id]` | プロジェクト削除 | ✅ |
| GET | `/api/tasks` | タスク一覧取得 | ✅ |
| POST | `/api/tasks` | タスク作成 | ✅ |
| GET | `/api/tasks/[id]` | タスク詳細取得 | ✅ |
| PATCH | `/api/tasks/[id]` | タスク更新 | ✅ |
| DELETE | `/api/tasks/[id]` | タスク削除 | ✅ |

### 5.2 追加API（未実装）

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| GET | `/api/projects/[id]/tasks` | プロジェクト配下のタスク一覧 |
| POST | `/api/projects/[id]/calculate-progress` | プロジェクト進捗再計算 |
| GET | `/api/dashboard/stats` | ダッシュボード統計データ |
| GET | `/api/users` | ユーザー一覧（担当者選択用） |
| POST | `/api/tasks/[id]/comments` | コメント投稿 |
| GET | `/api/tasks/[id]/comments` | コメント一覧取得 |

## 6. 実装優先度

### Phase 1: 基本機能強化（1-2週間）

1. ✅ ~~プロジェクト・タスク詳細ページ~~ **完了**
2. ⏳ **編集フォームの実装**
   - プロジェクト編集画面
   - タスク編集画面
   - 共通フォームコンポーネント
3. ⏳ **削除機能の実装**
   - 確認ダイアログ
   - 関連データ処理
4. ⏳ **プロジェクト進捗自動計算**
   - API実装
   - フロントエンド連携

### Phase 2: UX改善（1週間）

5. ⏳ **新規作成フォーム**
   - プロジェクト作成
   - タスク作成
6. ⏳ **フィルタリング強化**
   - プロジェクト一覧
   - タスク一覧
7. ⏳ **ダッシュボード**
   - 統計サマリー
   - 最近の活動

### Phase 3: 高度な機能（2週間）

8. ⏳ **カレンダー/スケジュール表示**
   - カレンダービュー
   - タイムライン表示
9. ⏳ **タスク進捗率の追加**
   - データベース追加
   - UI実装
10. ⏳ **サブタスク機能**
    - 親子関係実装
    - ネスト表示

### Phase 4: 拡張機能（将来）

11. ⏳ コメント機能
12. ⏳ 添付ファイル
13. ⏳ 工数管理（Time Logs）
14. ⏳ 通知機能
15. ⏳ レポート機能

## 7. 技術的考慮事項

### 7.1 パフォーマンス

- **ページネーション**: タスク・プロジェクトが大量になった場合
- **キャッシング**: React Query または SWR の導入検討
- **楽観的UI更新**: 更新時の即時反映

### 7.2 セキュリティ

- **認証**: NextAuth.js による認証（既存実装）
- **認可**: ユーザーごとのアクセス制御
- **バリデーション**: フロント・バックエンド両方で実施

### 7.3 データ整合性

- **トランザクション**: プロジェクト削除時の関連タスク処理
- **制約**: 外部キー制約の適切な設定
- **バリデーション**: 日付の妥当性チェック（開始日 <= 終了日）

## 8. マイグレーション計画

### 8.1 データベース追加フィールド

```javascript
// projects に追加
{
  auto_progress: boolean (default: true),
  budget: decimal,
  actual_cost: decimal
}

// tasks に追加
{
  progress: integer (0-100, default: 0),
  estimated_hours: decimal,
  actual_hours: decimal,
  parent_task: integer (foreign key to tasks.id),
  sort_order: integer (default: 0)
}
```

### 8.2 新規コレクション作成順序

1. `task_comments`
2. `task_attachments`
3. `project_members`
4. `time_logs`

## 9. まとめ

### 現在の実装状況
- ✅ 基本CRUD（プロジェクト・タスク）
- ✅ 詳細ページ
- ✅ 一覧ページ
- ✅ 基本的なリレーション

### 次のステップ（推奨）
1. **編集・削除機能の実装** ← まずこれ
2. **プロジェクト進捗自動計算**
3. **新規作成フォーム**
4. **ダッシュボード**
5. **カレンダー/スケジュール**

---

**作成日**: 2025-10-24
**バージョン**: 1.0
**ステータス**: 設計中
